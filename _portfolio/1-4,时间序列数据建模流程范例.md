---
title: "1-4.æ—¶é—´åºåˆ—æ•°æ®å»ºæ¨¡æµç¨‹èŒƒä¾‹"
excerpt: '2020å¹´å‘ç”Ÿçš„æ–°å† è‚ºç‚ç–«æƒ…ç¾éš¾ç»™å„å›½äººæ°‘çš„ç”Ÿæ´»é€ æˆäº†è¯¸å¤šæ–¹é¢çš„å½±å“
<br/><img src="/images/pyspark.png" width="600">'
collection: portfolio
---

2020å¹´å‘ç”Ÿçš„æ–°å† è‚ºç‚ç–«æƒ…ç¾éš¾ç»™å„å›½äººæ°‘çš„ç”Ÿæ´»é€ æˆäº†è¯¸å¤šæ–¹é¢çš„å½±å“ã€‚

æœ‰çš„åŒå­¦æ˜¯æ”¶å…¥ä¸Šçš„ï¼Œæœ‰çš„åŒå­¦æ˜¯æ„Ÿæƒ…ä¸Šçš„ï¼Œæœ‰çš„åŒå­¦æ˜¯å¿ƒç†ä¸Šçš„ï¼Œè¿˜æœ‰çš„åŒå­¦æ˜¯ä½“é‡ä¸Šçš„ã€‚

æœ¬æ–‡åŸºäºä¸­å›½2020å¹´3æœˆä¹‹å‰çš„ç–«æƒ…æ•°æ®ï¼Œå»ºç«‹æ—¶é—´åºåˆ—RNNæ¨¡å‹ï¼Œå¯¹ä¸­å›½çš„æ–°å† è‚ºç‚ç–«æƒ…ç»“æŸæ—¶é—´è¿›è¡Œé¢„æµ‹ã€‚




```python
import torch 
print("torch.__version__ = ", torch.__version__)


```

    torch.__version__ =  2.0.1


<br>


```python
import os

#macç³»ç»Ÿä¸Špytorchå’Œmatplotlibåœ¨jupyterä¸­åŒæ—¶è·‘éœ€è¦æ›´æ”¹ç¯å¢ƒå˜é‡
os.environ["KMP_DUPLICATE_LIB_OK"]="TRUE" 

```



## ä¸€ï¼Œå‡†å¤‡æ•°æ®

æœ¬æ–‡çš„æ•°æ®é›†å–è‡ªtushareï¼Œè·å–è¯¥æ•°æ®é›†çš„æ–¹æ³•å‚è€ƒäº†ä»¥ä¸‹æ–‡ç« ã€‚

ã€Šhttps://zhuanlan.zhihu.com/p/109556102ã€‹




```python
import numpy as np
import pandas as pd 
import matplotlib.pyplot as plt

```


```python
%matplotlib inline
%config InlineBackend.figure_format = 'svg'

df = pd.read_csv("./eat_pytorch_datasets/covid-19.csv",sep = "\t")
df.plot(x = "date",y = ["confirmed_num","cured_num","dead_num"],figsize=(10,6))
plt.xticks(rotation=60);

```


    
    



```python
dfdata = df.set_index("date")
dfdiff = dfdata.diff(periods=1).dropna()
dfdiff = dfdiff.reset_index("date")

dfdiff.plot(x = "date",y = ["confirmed_num","cured_num","dead_num"],figsize=(10,6))
plt.xticks(rotation=60)
dfdiff = dfdiff.drop("date",axis = 1).astype("float32")

```


    
    



```python
dfdiff.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>confirmed_num</th>
      <th>cured_num</th>
      <th>dead_num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>457.0</td>
      <td>4.0</td>
      <td>16.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>688.0</td>
      <td>11.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>769.0</td>
      <td>2.0</td>
      <td>24.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1771.0</td>
      <td>9.0</td>
      <td>26.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1459.0</td>
      <td>43.0</td>
      <td>26.0</td>
    </tr>
  </tbody>
</table>
</div>



ä¸‹é¢æˆ‘ä»¬é€šè¿‡ç»§æ‰¿torch.utils.data.Datasetå®ç°è‡ªå®šä¹‰æ—¶é—´åºåˆ—æ•°æ®é›†ã€‚

torch.utils.data.Datasetæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œç”¨æˆ·æƒ³è¦åŠ è½½è‡ªå®šä¹‰çš„æ•°æ®åªéœ€è¦ç»§æ‰¿è¿™ä¸ªç±»ï¼Œå¹¶ä¸”è¦†å†™å…¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•å³å¯ï¼š

* `__len__`:å®ç°len(dataset)è¿”å›æ•´ä¸ªæ•°æ®é›†çš„å¤§å°ã€‚
* `__getitem__`:ç”¨æ¥è·å–ä¸€äº›ç´¢å¼•çš„æ•°æ®ï¼Œä½¿`dataset[i]`è¿”å›æ•°æ®é›†ä¸­ç¬¬iä¸ªæ ·æœ¬ã€‚

ä¸è¦†å†™è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šç›´æ¥è¿”å›é”™è¯¯ã€‚



```python
import torch 
from torch import nn 
from torch.utils.data import Dataset,DataLoader,TensorDataset


#ç”¨æŸæ—¥å‰8å¤©çª—å£æ•°æ®ä½œä¸ºè¾“å…¥é¢„æµ‹è¯¥æ—¥æ•°æ®
WINDOW_SIZE = 8

class Covid19Dataset(Dataset):
        
    def __len__(self):
        return len(dfdiff) - WINDOW_SIZE
    
    def __getitem__(self,i):
        x = dfdiff.loc[i:i+WINDOW_SIZE-1,:]
        feature = torch.tensor(x.values)
        y = dfdiff.loc[i+WINDOW_SIZE,:]
        label = torch.tensor(y.values)
        return (feature,label)
    
ds_train = Covid19Dataset()

#æ•°æ®è¾ƒå°ï¼Œå¯ä»¥å°†å…¨éƒ¨è®­ç»ƒæ•°æ®æ”¾å…¥åˆ°ä¸€ä¸ªbatchä¸­ï¼Œæå‡æ€§èƒ½
dl_train = DataLoader(ds_train,batch_size = 38)

for features,labels in dl_train:
    break 
    
#dl_trainåŒæ—¶ä½œä¸ºéªŒè¯é›†
dl_val = dl_train

```

## äºŒï¼Œå®šä¹‰æ¨¡å‹

ä½¿ç”¨Pytorché€šå¸¸æœ‰ä¸‰ç§æ–¹å¼æ„å»ºæ¨¡å‹ï¼šä½¿ç”¨nn.SequentialæŒ‰å±‚é¡ºåºæ„å»ºæ¨¡å‹ï¼Œç»§æ‰¿nn.ModuleåŸºç±»æ„å»ºè‡ªå®šä¹‰æ¨¡å‹ï¼Œç»§æ‰¿nn.ModuleåŸºç±»æ„å»ºæ¨¡å‹å¹¶è¾…åŠ©åº”ç”¨æ¨¡å‹å®¹å™¨è¿›è¡Œå°è£…ã€‚

æ­¤å¤„é€‰æ‹©ç¬¬äºŒç§æ–¹å¼æ„å»ºæ¨¡å‹ã€‚




```python
import torch
from torch import nn 
import importlib 
import torchkeras 

torch.random.seed()

class Block(nn.Module):
    def __init__(self):
        super(Block,self).__init__()
    
    def forward(self,x,x_input):
        x_out = torch.max((1+x)*x_input[:,-1,:],torch.tensor(0.0))
        return x_out
    
class Net(nn.Module):
    def __init__(self):
        super(Net, self).__init__()
        # 3å±‚lstm
        self.lstm = nn.LSTM(input_size = 3,hidden_size = 3,num_layers = 5,batch_first = True)
        self.linear = nn.Linear(3,3)
        self.block = Block()
        
    def forward(self,x_input):
        x = self.lstm(x_input)[0][:,-1,:]
        x = self.linear(x)
        y = self.block(x,x_input)
        return y
        
net = Net()
print(net)


```

    Net(
      (lstm): LSTM(3, 3, num_layers=5, batch_first=True)
      (linear): Linear(in_features=3, out_features=3, bias=True)
      (block): Block()
    )


```
Net(
  (lstm): LSTM(3, 3, num_layers=5, batch_first=True)
  (linear): Linear(in_features=3, out_features=3, bias=True)
  (block): Block()
)
```


```python
from torchkeras import summary
summary(net,input_data=features);
```

    --------------------------------------------------------------------------
    Layer (type)                            Output Shape              Param #
    ==========================================================================
    LSTM-1                                    [-1, 8, 3]                  480
    Linear-2                                     [-1, 3]                   12
    Block-3                                      [-1, 3]                    0
    ==========================================================================
    Total params: 492
    Trainable params: 492
    Non-trainable params: 0
    --------------------------------------------------------------------------
    Input size (MB): 0.000069
    Forward/backward pass size (MB): 0.000229
    Params size (MB): 0.001877
    Estimated Total Size (MB): 0.002174
    --------------------------------------------------------------------------



```python

```

### ä¸‰ï¼Œè®­ç»ƒæ¨¡å‹

è®­ç»ƒPytorché€šå¸¸éœ€è¦ç”¨æˆ·ç¼–å†™è‡ªå®šä¹‰è®­ç»ƒå¾ªç¯ï¼Œè®­ç»ƒå¾ªç¯çš„ä»£ç é£æ ¼å› äººè€Œå¼‚ã€‚

æœ‰3ç±»å…¸å‹çš„è®­ç»ƒå¾ªç¯ä»£ç é£æ ¼ï¼šè„šæœ¬å½¢å¼è®­ç»ƒå¾ªç¯ï¼Œå‡½æ•°å½¢å¼è®­ç»ƒå¾ªç¯ï¼Œç±»å½¢å¼è®­ç»ƒå¾ªç¯ã€‚

æ­¤å¤„æˆ‘ä»¬é€šè¿‡å¼•å…¥torchkerasåº“ä¸­çš„KerasModelå·¥å…·æ¥è®­ç»ƒæ¨¡å‹ï¼Œæ— éœ€ç¼–å†™è‡ªå®šä¹‰å¾ªç¯ã€‚

torchkerasè¯¦æƒ…:  https://github.com/lyhue1991/torchkeras 

æ³¨ï¼šå¾ªç¯ç¥ç»ç½‘ç»œè°ƒè¯•è¾ƒä¸ºå›°éš¾ï¼Œéœ€è¦è®¾ç½®å¤šä¸ªä¸åŒçš„å­¦ä¹ ç‡å¤šæ¬¡å°è¯•ï¼Œä»¥å–å¾—è¾ƒå¥½çš„æ•ˆæœã€‚




```python
from torchmetrics.regression import MeanAbsolutePercentageError

def mspe(y_pred,y_true):
    err_percent = (y_true - y_pred)**2/(torch.max(y_true**2,torch.tensor(1e-7)))
    return torch.mean(err_percent)

net = Net() 
loss_fn = mspe
metric_dict = {"mape":MeanAbsolutePercentageError()}

optimizer = torch.optim.Adam(net.parameters(), lr=0.03)
lr_scheduler = torch.optim.lr_scheduler.StepLR(optimizer, step_size=10, gamma=0.0001)
```


```python
from torchkeras import KerasModel 
model = KerasModel(net,
       loss_fn = loss_fn,
       metrics_dict= metric_dict,
       optimizer = optimizer,
       lr_scheduler = lr_scheduler) 

```


```python
dfhistory = model.fit(train_data=dl_train,
            val_data=dl_val,
            epochs=100,
            ckpt_path='checkpoint',
            patience=10,
            monitor='val_loss',
            mode='min',
            callbacks=None,
            plot=True,
            cpu=True
            )

```

    [0;31m<<<<<< ğŸŒ cpu is used >>>>>>[0m



    
    




<style>
    /* background: */
    progress::-webkit-progress-bar {background-color: #CDCDCD; width: 100%;}
    progress {background-color: #CDCDCD;}

    /* value: */
    progress::-webkit-progress-value {background-color: #00BFFF  !important;}
    progress::-moz-progress-bar {background-color: #00BFFF  !important;}
    progress {color: #00BFFF ;}

    /* optional */
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #000000;
    }
</style>





<div>
  <progress value='18' class='progress-bar-interrupted' max='100' style='width:300px; height:20px; vertical-align: middle;'></progress>
  18.00% [18/100] [00:02<00:10]
  <br>
  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ100.00% [1/1] [val_loss=0.4363, val_mape=0.5570]
</div>



    [0;31m<<<<<< val_loss without improvement in 10 epoch,early stopping >>>>>> 
    [0m



```python

```

### å››ï¼Œè¯„ä¼°æ¨¡å‹

è¯„ä¼°æ¨¡å‹ä¸€èˆ¬è¦è®¾ç½®éªŒè¯é›†æˆ–è€…æµ‹è¯•é›†ï¼Œç”±äºæ­¤ä¾‹æ•°æ®è¾ƒå°‘ï¼Œæˆ‘ä»¬ä»…ä»…å¯è§†åŒ–æŸå¤±å‡½æ•°åœ¨è®­ç»ƒé›†ä¸Šçš„è¿­ä»£æƒ…å†µã€‚


```python
model.evaluate(dl_val)

```

    100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1/1 [00:00<00:00, 63.91it/s, val_loss=0.384, val_mape=0.505]





    {'val_loss': 0.38373321294784546, 'val_mape': 0.5048269033432007}




```python

```

### äº”ï¼Œä½¿ç”¨æ¨¡å‹

æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨æ¨¡å‹é¢„æµ‹ç–«æƒ…ç»“æŸæ—¶é—´ï¼Œå³ æ–°å¢ç¡®è¯Šç—…ä¾‹ä¸º0 çš„æ—¶é—´ã€‚


```python
#ä½¿ç”¨dfresultè®°å½•ç°æœ‰æ•°æ®ä»¥åŠæ­¤åé¢„æµ‹çš„ç–«æƒ…æ•°æ®
dfresult = dfdiff[["confirmed_num","cured_num","dead_num"]].copy()
dfresult.tail()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>confirmed_num</th>
      <th>cured_num</th>
      <th>dead_num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>41</th>
      <td>143.0</td>
      <td>1681.0</td>
      <td>30.0</td>
    </tr>
    <tr>
      <th>42</th>
      <td>99.0</td>
      <td>1678.0</td>
      <td>28.0</td>
    </tr>
    <tr>
      <th>43</th>
      <td>44.0</td>
      <td>1661.0</td>
      <td>27.0</td>
    </tr>
    <tr>
      <th>44</th>
      <td>40.0</td>
      <td>1535.0</td>
      <td>22.0</td>
    </tr>
    <tr>
      <th>45</th>
      <td>19.0</td>
      <td>1297.0</td>
      <td>17.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
#é¢„æµ‹æ­¤å1000å¤©çš„æ–°å¢èµ°åŠ¿,å°†å…¶ç»“æœæ·»åŠ åˆ°dfresultä¸­
for i in range(1000):
    arr_input = torch.unsqueeze(torch.from_numpy(dfresult.values[-38:,:]),axis=0)
    arr_predict = model.forward(arr_input)

    dfpredict = pd.DataFrame(torch.floor(arr_predict).data.numpy(),
                columns = dfresult.columns)
    dfresult = pd.concat([dfresult,dfpredict],ignore_index=True)
```


```python
dfresult.query("confirmed_num==0").head()

# ç¬¬50å¤©å¼€å§‹æ–°å¢ç¡®è¯Šé™ä¸º0ï¼Œç¬¬45å¤©å¯¹åº”3æœˆ10æ—¥ï¼Œä¹Ÿå°±æ˜¯5å¤©åï¼Œå³é¢„è®¡3æœˆ15æ—¥æ–°å¢ç¡®è¯Šé™ä¸º0
# æ³¨ï¼šè¯¥é¢„æµ‹åä¹è§‚

```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>confirmed_num</th>
      <th>cured_num</th>
      <th>dead_num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>50</th>
      <td>0.0</td>
      <td>999.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>0.0</td>
      <td>948.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>52</th>
      <td>0.0</td>
      <td>900.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>53</th>
      <td>0.0</td>
      <td>854.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>0.0</td>
      <td>810.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>





```python
dfresult.query("cured_num==0").head()
# ç¬¬137å¤©å¼€å§‹æ–°å¢æ²»æ„ˆé™ä¸º0ï¼Œç¬¬45å¤©å¯¹åº”3æœˆ10æ—¥ï¼Œä¹Ÿå°±æ˜¯å¤§æ¦‚3ä¸ªæœˆåï¼Œå³6æœˆ12æ—¥å·¦å³å…¨éƒ¨æ²»æ„ˆã€‚
# æ³¨: è¯¥é¢„æµ‹åæ‚²è§‚ï¼Œå¹¶ä¸”å­˜åœ¨é—®é¢˜ï¼Œå¦‚æœå°†æ¯å¤©æ–°å¢æ²»æ„ˆäººæ•°åŠ èµ·æ¥ï¼Œå°†è¶…è¿‡ç´¯è®¡ç¡®è¯Šäººæ•°ã€‚
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>confirmed_num</th>
      <th>cured_num</th>
      <th>dead_num</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>137</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>138</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>139</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>140</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>141</th>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div>





### å…­ï¼Œä¿å­˜æ¨¡å‹

æ¨¡å‹æƒé‡ä¿å­˜åœ¨äº†model.ckpt_pathè·¯å¾„ã€‚


```python
print(model.ckpt_path)
```

    checkpoint



```python
model.load_ckpt('checkpoint') #å¯ä»¥åŠ è½½æƒé‡
```
